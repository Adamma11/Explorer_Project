const CdePassword = require('../../models/administration/cde_password.model')
const generateCdeToken = require('../../shared/generate_cde_token');
const express = require('express');
const nodeMailer = require('nodemailer');
const mailSend = require('../mails/send_mail.controller')
const EmailTemplate = require('../../models/masters/email_template.model')
const Case = require('../../models/uploads/case.model')

const { resolveContent } = require('nodemailer/lib/shared');
const { rejectConvertRequest } = require('../sales/lead_or_prospect.controller');
const { response } = require('express');


exports.create = (req,res)=>{
    CdePassword.deleteOne({caseId:req.body.caseId})
    .then(cdePassword=>{
        savePassword();
    })
    function savePassword(){
        const cdePassword = new CdePassword({
            caseId:req.body.caseId,
            password:req.body.password
        })
        cdePassword.save(cdePassword)
        .then(data=>{
            checkAndSendMail()
            res.json({
               message:"Mail Sent"
            })
  	
/*            let transporter = nodeMailer.createTransport({
                host:"smtp.office365.com",
                port:587,
                secure:false,
                auth:{
                    user:"info@adamma.in",
                    pass:"Adamma@123"
                }
            })
            let mailOptions = {
                from:"info@adamma.in",
                to:req.body.emailId,
                subject:"Welcome to Explorer (Powered by Adamma)",
                text: "Dear " + req.body.name + ",\n\n" + "Welcome to Explorer!\n\n" + "Your account has been created. You can now login using the following credentials.\n\n" + "URL:http://172.16.16.46/\n" + "Reference Id :" + req.body.caseId + "\n" + "Password :" + req.body.password + "\n\n"   + "Need any help ?" + "Write to support.vibe@verifacts.co.in\n\n" + "This is autogenerated email, please do not respond.\n\n" + "Thank you,\n" + "Team Explorer"
            }
            transporter.sendMail(mailOptions,function(error,info){
                if(error){
                    console.log(error);
                    res.status(500).json({message:error.message || "Some error occured while saving user password"})
                }else{
                    res.status(200).json({message:"Password generated successfully"});
                }
            })*/

        })
        .catch(err=>{
            res.status(500).json({message:err.message || "Some error occured while saving user password"})
        })
    }
    function checkAndSendMail(){
       console.log("About to send mail")
       Case
       .findOne({caseId:req.body.caseId})
       .populate({path:'subclient',populate:{path:'client'}})
       .then(caseData=>{
           console.log("Got Case Details")
           EmailTemplate
          .findOne({name:'CDE General'})
          .then(emailTemplateData=>{
              console.log("Glot email template details")
              let mailAddress = caseData.candidateEmail;
              let subject = "Request for Submission of Information (Ref No."+ req.body.caseId+ ")"
              let mailText = emailTemplateData.content
              let changedMailText = mailText.replace('(Candidate Name)',caseData.candidateName)
              changedMailText = changedMailText.replace('(Client Name)',caseData.subclient.client.name)
              changedMailText = changedMailText.replace('(USER ID)',req.body.caseId)
              changedMailText = changedMailText.replace('(PASSWORD)',req.body.password)
              changedMailText = changedMailText.replace(';','')		  
              changedMailText = changedMailText.replace(';','')
              changedMailText = changedMailText.replace(';','')
	      changedMailText = changedMailText.replace(';','')
	      changedMailText = changedMailText.replace(';','')
	      changedMailText = changedMailText.replace(';','')	  
              let mailSent = mailSend.sendMail(mailAddress,subject,changedMailText)
              return mailSent
          })
          .catch(err=>{
              console.log("Error getting email template details ",err)
              res.status(500).json({
                      message:"Error getting email details"
              })
          })
       })
       .catch(err=>{
          console.log("Error getting case details")
          res.status(500).json({
             message:"Error getting case details"
          })
       })

    }
	

}
exports.createRejectionPassword = (req,res)=>{
    CdePassword.deleteOne({caseId:req.body.caseId})
    .then(cdePassword=>{
        savePassword();
    })
    function savePassword(){
        const cdePassword = new CdePassword({
            caseId:req.body.caseId,
            password:req.body.password
        })
        cdePassword.save(cdePassword)
        .then(data=>{
            checkAndSendMail()
            res.json({
               message:"Mail Sent"
            })
        })
        .catch(err=>{
            res.status(500).json({message:err.message || "Some error occured while saving user password"})
        })
    }
    function checkAndSendMail(){
       console.log("About to send mail")
       Case
       .findOne({caseId:req.body.caseId})
       .populate({path:'subclient',populate:{path:'client'}})
       .then(caseData=>{
           console.log("Got Case Details")
           EmailTemplate
          .findOne({name:'CDE Rejection'})
          .then(emailTemplateData=>{
              console.log("Glot email template details")
              let mailAddress = caseData.candidateEmail;
              let subject = "Request for Submission of Information (Ref No."+ req.body.caseId+ ")"
              let mailText = emailTemplateData.content
              let changedMailText = mailText.replace('(Candidate Name)',caseData.candidateName)
              changedMailText = changedMailText.replace('(Client Name)',caseData.subclient.client.name)
              changedMailText = changedMailText.replace('(USER ID)',req.body.caseId)
	      changedMailText = changedMailText.replace('(USER ID)',req.body.caseId)	  
              changedMailText = changedMailText.replace('(PASSWORD)',req.body.password)
              let mailSent = mailSend.sendMail(mailAddress,subject,changedMailText)
              return mailSent
          })
          .catch(err=>{
              console.log("Error getting email template details ",err)
              res.status(500).json({
                      message:"Error getting email details"
              })
          })
       })
       .catch(err=>{
          console.log("Error getting case details")
          res.status(500).json({
             message:"Error getting case details"
          })
       })

    }

}

exports.validate = (req,res)=>{
    let validateTheCase = function(){
        return new Promise(function(resolve,reject){
            CdePassword.findOne({caseId:req.body.caseId})
            .then(cdePassword=>{
                if(cdePassword != null){
                    resolve(cdePassword.caseId)
                }else{
                  reject(null);
                }
            })
            .catch(err=>{
                reject(null)
            })
        })
    }

    let comparePasswords = function(caseId){
        return new Promise(function(resolve,reject){
            CdePassword.findOne({caseId:caseId})
            .then(cdePassword=>{
                if(cdePassword){
                    cdePassword.comparePassword(req.body.password,function(err,isMatch){
                        if(err){
                            reject(null);
                        }
                        if(isMatch){
                            const accessToken = generateCdeToken({caseId:caseId},"ACCESS");
                            resolve(accessToken)
                        }else{
                            reject(null)
                        }
                    })
                }else{
                    reject(null)
                }
            })
            .catch(err=>{
                reject(null);
            })
        })

    }
    validateAndSendTheRequiredData();
    async function validateAndSendTheRequiredData(){
        try{
            let caseId = await validateTheCase();
            if(caseId == null){
                console.log("User Id is null");
                res.status(401).json({message:"Invalid User"})
            }else{
                let accessToken = await comparePasswords(caseId);
                if(accessToken == null){
                    res.status(401).json({message:"Invaid Password"})
                }else{
                    res.status(200).json({accessToken:accessToken})
                }
            }
        }catch(err){
            res.status(401).json({message:"Invaid User / Password"})
        }

/*         console.log("Screens required are ",screensForRoles);
        if(accessToken != null){
            console.log("Validation successful");
            res.status(200).json({accessToken:accessToken,roles:userRoles})
        }else{
            console.log("Validation failure");
            res.status(401).json({message:"Password Validation Failed"});
        } */

    }

}
exports.createForChangePassword = (req,res)=>{
    CdePassword.deleteOne({caseId:req.caseId})
    .then(userPassword=>{
        savePassword();
    })
    function savePassword(){
        const cdePassword = new CdePassword({
            caseId:req.caseId,
            password:req.body.password
        })
        cdePassword.save(cdePassword)
        .then(data=>{
            res.status(200).json({message:"Password generated successfully"});
        })
        .catch(err=>{
            res.status(500).json({message:err.message || "Some error occured while saving user password"})
        })
    }

}

